name: TestFlight Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
  workflow_dispatch:

env:
  SCHEME: 'TodoApp'

jobs:
  build-and-release:
    name: Build and Submit to TestFlight
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Check for XcodeGen
      run: |
        if ! command -v xcodegen &> /dev/null; then
          echo "Installing XcodeGen..."
          brew install xcodegen
        else
          echo "XcodeGen already installed"
        fi

    - name: Generate Xcode project
      run: xcodegen generate

    - name: Resolve dependencies
      run: xcodebuild -resolvePackageDependencies -project TodoApp.xcodeproj -scheme ${{ env.SCHEME }}

    - name: Import App Store certificates and provisioning profiles
      env:
        APPSTORE_CERTIFICATE_BASE64: ${{ secrets.APPSTORE_CERTIFICATE_BASE64 }}
        APPSTORE_P12_PASSWORD: ${{ secrets.APPSTORE_P12_PASSWORD }}
        APPSTORE_PROVISION_PROFILE_BASE64: ${{ secrets.APPSTORE_PROVISION_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create variables
        CERTIFICATE_PATH=$RUNNER_TEMP/appstore_certificate.p12
        PP_PATH=$RUNNER_TEMP/appstore_pp.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # Import certificate and provisioning profile from secrets
        echo -n "$APPSTORE_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
        echo -n "$APPSTORE_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Import certificate to keychain
        security import $CERTIFICATE_PATH -P "$APPSTORE_P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

        # Apply provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

    - name: Get version from project
      id: version
      run: |
        VERSION=$(grep "MARKETING_VERSION" project.yml | awk '{print $2}' | tr -d '"')
        BUILD_NUMBER=${{ github.run_number }}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION ($BUILD_NUMBER)"

    - name: Build for App Store
      run: |
        xcodebuild archive \
          -project TodoApp.xcodeproj \
          -scheme ${{ env.SCHEME }} \
          -configuration Release \
          -archivePath $RUNNER_TEMP/TodoApp.xcarchive \
          -destination 'generic/platform=iOS' \
          MARKETING_VERSION=${{ steps.version.outputs.VERSION }} \
          CURRENT_PROJECT_VERSION=${{ steps.version.outputs.BUILD_NUMBER }}

    - name: Export IPA for App Store
      run: |
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/TodoApp.xcarchive \
          -exportOptionsPlist .github/workflows/ExportOptions-AppStore.plist \
          -exportPath $RUNNER_TEMP/build \
          -allowProvisioningUpdates

    - name: Upload to TestFlight
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
      run: |
        # Create API key file
        mkdir -p ~/.appstoreconnect/private_keys
        echo -n "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8

        # Upload to TestFlight
        xcrun altool --upload-app \
          --type ios \
          --file $RUNNER_TEMP/build/TodoApp.ipa \
          --apiKey $APP_STORE_CONNECT_API_KEY_ID \
          --apiIssuer $APP_STORE_CONNECT_ISSUER_ID

    - name: Upload IPA as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TodoApp-AppStore-${{ steps.version.outputs.VERSION }}-${{ steps.version.outputs.BUILD_NUMBER }}
        path: ${{ runner.temp }}/build/TodoApp.ipa
        retention-days: 90

    - name: Create GitHub Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}-${{ steps.version.outputs.BUILD_NUMBER }}
        name: Release ${{ steps.version.outputs.VERSION }} (Build ${{ steps.version.outputs.BUILD_NUMBER }})
        body: |
          ## üöÄ Release ${{ steps.version.outputs.VERSION }}

          **Build:** ${{ steps.version.outputs.BUILD_NUMBER }}
          **Submitted to:** TestFlight

          ### üì¶ Changes
          ${{ github.event.head_commit.message }}

          ### üì± TestFlight
          This build has been automatically submitted to TestFlight.
          It will be available for testing once Apple completes processing (usually 15-30 minutes).

          ### üîó Links
          - [TestFlight on App Store Connect](https://appstoreconnect.apple.com/apps)
          - [Commit Details](${{ github.event.head_commit.url }})
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up keychain and provisioning profile
      if: always()
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/appstore_pp.mobileprovision || true
        rm -rf ~/.appstoreconnect || true

    - name: Notify on success
      if: success()
      run: |
        echo "‚úÖ Successfully uploaded to TestFlight!"
        echo "Version: ${{ steps.version.outputs.VERSION }}"
        echo "Build: ${{ steps.version.outputs.BUILD_NUMBER }}"

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå TestFlight upload failed!"
        echo "Check the logs above for details."
